# Azure startup commands for Django
# Set working directory to wwwroot (where backend files are deployed)
cd /home/site/wwwroot

# Set up Python path
export PYTHON_PATH="/opt/python/3.10.17/bin/python"

# Check if MySQL is ready before proceeding
echo "Waiting for MySQL connection..."
$PYTHON_PATH -c "import time; \
try: \
    import MySQLdb; \
except ImportError: \
    import pymysql; \
    pymysql.install_as_MySQLdb(); \
    import MySQLdb; \
count=0; \
while count < 10: \
    try: \
        MySQLdb.connect(host='servicesbladi.mysql.database.azure.com', user='servicesbladiadmin', passwd='Aa123456a', db='servicesbladi', ssl=False); \
        break; \
    except Exception as e: \
        print(f'MySQL connection attempt {count+1}/10 failed: {e}'); \
        count += 1; \
        time.sleep(5); \
" || echo "MySQL connection check failed, but continuing anyway"

# Run migrations with error handling
$PYTHON_PATH manage.py migrate --noinput || echo "Migration failed but continuing"

# Create cache table with error handling
$PYTHON_PATH manage.py createcachetable --noinput || echo "Cache table creation failed but continuing"

# Start Gunicorn (using the virtual environment's gunicorn)
/home/site/wwwroot/antenv/bin/gunicorn servicesbladi.wsgi:application --config gunicorn.conf.py
