# Azure startup commands for Django
# This script runs after Oryx build completion
# Set working directory to wwwroot (where backend files are deployed)
cd /home/site/wwwroot

# Activate virtual environment created by Oryx
source /home/site/wwwroot/antenv/bin/activate

# Check if MySQL is ready before proceeding
echo "Waiting for MySQL connection..."
python -c "import time; \
try: \
    import MySQLdb; \
except ImportError: \
    import pymysql; \
    pymysql.install_as_MySQLdb(); \
    import MySQLdb; \
count=0; \
while count < 10: \
    try: \
        MySQLdb.connect(host='servicesbladi.mysql.database.azure.com', user='servicesbladiadmin', passwd='Aa123456a', db='servicesbladi', ssl=False); \
        print('MySQL connection successful!'); \
        break; \
    except Exception as e: \
        print(f'MySQL connection attempt {count+1}/10 failed: {e}'); \
        count += 1; \
        time.sleep(5); \
" || echo "MySQL connection check failed, but continuing anyway"

# Run migrations with error handling
python manage.py migrate --noinput || echo "Migration failed but continuing"

# Create cache table with error handling
python manage.py createcachetable --noinput || echo "Cache table creation failed but continuing"

# Start Gunicorn using the activated virtual environment
exec gunicorn servicesbladi.wsgi:application --config gunicorn.conf.py
